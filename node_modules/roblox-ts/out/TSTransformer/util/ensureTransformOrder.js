"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ensureTransformOrder = void 0;
const byots_1 = __importDefault(require("byots"));
const LuauAST_1 = __importDefault(require("../../LuauAST"));
const findLastIndex_1 = require("../../Shared/util/findLastIndex");
const transformExpression_1 = require("../nodes/expressions/transformExpression");
const isDefinedAsLet_1 = require("./isDefinedAsLet");
function ensureTransformOrder(state, expressions, transformer = transformExpression_1.transformExpression) {
    const expressionInfoList = expressions.map((exp, index) => state.capture(() => transformer(state, exp, index)));
    const lastArgWithPrereqsIndex = findLastIndex_1.findLastIndex(expressionInfoList, info => !LuauAST_1.default.list.isEmpty(info[1]));
    const result = new Array();
    for (let i = 0; i < expressionInfoList.length; i++) {
        const info = expressionInfoList[i];
        state.prereqList(info[1]);
        let isConstVar = false;
        const exp = expressions[i];
        if (byots_1.default.isIdentifier(exp)) {
            const symbol = state.typeChecker.getSymbolAtLocation(exp);
            if (symbol && !isDefinedAsLet_1.isDefinedAsLet(state, symbol)) {
                isConstVar = true;
            }
        }
        let expression = info[0];
        if (i < lastArgWithPrereqsIndex &&
            !LuauAST_1.default.isSimplePrimitive(expression) &&
            !LuauAST_1.default.isTemporaryIdentifier(expression) &&
            !isConstVar) {
            expression = state.pushToVar(expression, "exp");
        }
        result.push(expression);
    }
    return result;
}
exports.ensureTransformOrder = ensureTransformOrder;
//# sourceMappingURL=ensureTransformOrder.js.map